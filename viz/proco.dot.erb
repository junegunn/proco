#!rake viz
<%
  clients = (ENV['C'] || 6).to_i
  queues  = (ENV['Q'] || 4).to_i
  threads = (ENV['T'] || 5).to_i
%>
digraph G {
  // Comic Sans FTW!
  graph [fontname = "Comic Sans"];
  node  [fontname = "Comic Sans"];
  edge  [fontname = "Comic Sans"];

  rankdir = LR;
  ranksep = 1;
  ranksep = 0.5;

<% clients.times do |i| %>
  C<%= i %> [shape = ellipse, label = "Client"];
  C<%= i %> -> G;
<% end %>

  subgraph cluster_proco {
    G [label = "Proco", shape = circle];

    subgraph cluster_queues {
      label = "Buffer";
    <% queues.times do |i| %>
      Q<%= i %> [shape = record, height = 0.01, label = "{<h> | | | | |<t> }"];
      D<%= i %> [label = "Dispatcher"];
      Q<%= i %> -> D<%= i %>;
    <% end %>
    }
    subgraph cluster_threqds {
      label = "Executor Pool";
      <% threads.times do |t| %>
        T<%= t %> [shape = box3d, label = "Executor"];
      <% end %>
    }
  }

  // T<%= threads - 1 %>:e -> C<%= clients - 1%> [constraint = false];

<% queues.times do |i| %>
  G -> Q<%= i %>:h:w;
  <% threads.times do |t| %>
  D<%= i %>:e -> T<%= t %>:w;
  <% end %>
<% end %>
}
